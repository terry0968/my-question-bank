<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 應用規劃師題庫 - 本地版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app" class="flex flex-col md:flex-row min-h-screen">
        <!-- 側邊欄 -->
        <aside class="w-full md:w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col md:h-screen sticky top-0 z-20">
            <div class="p-6 flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg">
                    <i data-lucide="book-open"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tighter">AI 題庫系統</h1>
            </div>
            
            <nav class="flex-1 px-4 py-2 space-y-1 flex flex-col">
                <button onclick="setView('list')" id="btn-list" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-indigo-600 shadow-lg">
                    <i data-lucide="layout"></i> <span class="font-bold">題庫總覽</span>
                </button>
                <button onclick="startQuiz()" id="btn-quiz" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-800">
                    <i data-lucide="refresh-cw"></i> <span class="font-bold">隨機測驗</span>
                </button>
                
                <div class="pt-6 mt-4 border-t border-slate-800">
                    <button onclick="toggleImportModal(true)" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-emerald-400 hover:bg-emerald-500/10 transition-colors border border-emerald-500/20">
                        <i data-lucide="upload-cloud"></i> <span class="font-bold">AI 批量解析</span>
                    </button>
                </div>
            </nav>
            
            <div class="p-4 m-4 bg-slate-800/50 rounded-xl space-y-2 text-center">
                <button onclick="exportData()" class="w-full flex items-center justify-center gap-2 py-2 text-xs font-bold text-slate-300 hover:text-white bg-slate-700 rounded-lg transition-colors">
                    <i data-lucide="download" class="w-3 h-3"></i> 備份 JSON
                </button>
                <button onclick="document.getElementById('importFile').click()" class="w-full flex items-center justify-center gap-2 py-2 text-xs font-bold text-slate-300 hover:text-white bg-slate-700 rounded-lg transition-colors">
                    <i data-lucide="upload" class="w-3 h-3"></i> 匯入備份
                </button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
            </div>
        </aside>

        <!-- 主內容區 -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden">
            <header class="bg-white border-b px-6 py-4 flex items-center justify-between shadow-sm z-10">
                <div class="relative max-w-md w-full">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" oninput="renderList()" placeholder="搜尋題目或分類..." class="w-full pl-10 pr-4 py-2 bg-slate-100 rounded-full text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all border-none">
                </div>
                <button onclick="toggleEditModal(true)" class="ml-4 bg-indigo-600 text-white px-6 py-2 rounded-full flex items-center gap-2 text-sm font-bold shadow-lg shadow-indigo-200">
                    <i data-lucide="plus" class="w-4 h-4"></i> <span>新增</span>
                </button>
            </header>

            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8"></div>
        </main>
    </div>

    <!-- 批量匯入 Modal -->
    <div id="import-modal" class="fixed inset-0 z-50 bg-slate-900/90 backdrop-blur-md hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-8 border-b flex justify-between items-center bg-slate-50">
                <h3 class="text-2xl font-black">AI 批量解析匯入</h3>
                <button onclick="toggleImportModal(false)" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="p-8 space-y-4 overflow-y-auto">
                <input type="text" id="i-category" placeholder="設定分類（如：AI應用規劃師）" class="w-full px-5 py-3 rounded-xl border-2 border-slate-100 font-bold outline-none focus:border-emerald-500">
                <textarea id="i-text" rows="12" class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 text-sm font-medium outline-none focus:border-emerald-500" placeholder="請貼上題目內容..."></textarea>
                <button onclick="processBatchImport()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black text-lg shadow-xl hover:bg-emerald-700 transition-all">確認匯入</button>
            </div>
        </div>
    </div>

    <!-- 編輯 Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl p-8 space-y-6">
            <div class="flex justify-between items-center">
                <h3 id="modal-title" class="text-2xl font-black">編輯題目</h3>
                <button onclick="toggleEditModal(false)" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <textarea id="f-question" rows="3" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 outline-none focus:border-indigo-500 font-bold" placeholder="題目內容..."></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="f-category" class="w-full px-4 py-2 rounded-xl border-2 border-slate-100 outline-none" placeholder="分類">
                    <select id="f-difficulty" class="w-full px-4 py-2 rounded-xl border-2 border-slate-100 outline-none">
                        <option value="低">簡單</option><option value="中" selected>普通</option><option value="高">困難</option>
                    </select>
                </div>
                <input type="text" id="f-answer" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 text-indigo-600 font-black" placeholder="答案">
                <textarea id="f-explanation" rows="2" class="w-full px-4 py-2 rounded-xl border-2 border-slate-100 text-sm" placeholder="解析..."></textarea>
            </div>
            <button onclick="saveQuestion()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black">儲存</button>
        </div>
    </div>

    <script>
        let questions = JSON.parse(localStorage.getItem('local_bank_v2')) || [];
        let currentView = 'list';
        let editingId = null;
        let quizList = [];
        let currentQuizIndex = 0;
        let showQuizAns = false;

        function saveToLocal() { localStorage.setItem('local_bank_v2', JSON.stringify(questions)); }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'shadow-lg', 'text-white');
                btn.classList.add('text-slate-400', 'hover:bg-slate-800');
            });
            const activeBtn = document.getElementById(`btn-${view}`);
            activeBtn.classList.remove('text-slate-400', 'hover:bg-slate-800');
            activeBtn.classList.add('bg-indigo-600', 'shadow-lg', 'text-white');
            render();
        }

        function renderList() {
            const container = document.getElementById('content-area');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = questions.filter(q => q.question.toLowerCase().includes(search) || q.category.toLowerCase().includes(search)).sort((a,b)=>b.updatedAt-a.updatedAt);
            
            if(filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-300"><i data-lucide="file-text" class="mx-auto w-16 h-16 mb-4"></i><p>尚無資料</p></div>`;
            } else {
                container.innerHTML = `<div class="max-w-4xl mx-auto space-y-6"><h2 class="text-2xl font-black">題目清單 (${filtered.length})</h2><div class="grid gap-4">${filtered.map(q => `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border group">
                        <div class="flex justify-between mb-2">
                            <span class="px-2 py-1 bg-indigo-50 text-indigo-600 text-[10px] font-black rounded uppercase tracking-wider">${q.category}</span>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                <button onclick="editQuestion(${q.id})" class="p-1 hover:text-indigo-600"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="deleteQuestion(${q.id})" class="p-1 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <p class="text-lg font-bold mb-4 whitespace-pre-wrap">${q.question}</p>
                        <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-sm font-black text-indigo-600">查看解答</button>
                        <div class="hidden mt-4 p-4 bg-slate-50 rounded-xl border font-bold text-emerald-600">答案：${q.answer}${q.explanation ? `<div class="text-slate-500 text-sm font-normal mt-2 border-l-2 pl-4 italic">解析：${q.explanation}</div>`:''}</div>
                    </div>
                `).join('')}</div></div>`;
            }
            lucide.createIcons();
        }

        function renderQuiz() {
            const container = document.getElementById('content-area');
            const q = quizList[currentQuizIndex];
            container.innerHTML = `<div class="max-w-2xl mx-auto py-10"><div class="bg-white rounded-[2rem] shadow-2xl overflow-hidden border">
                <div class="bg-slate-900 p-6 text-white flex justify-between"><span>智慧測驗</span><span>${currentQuizIndex+1}/${quizList.length}</span></div>
                <div class="p-10 text-center min-h-[300px] flex flex-col justify-center items-center">
                    <h2 class="text-2xl font-black mb-10 leading-relaxed">${q.question}</h2>
                    ${showQuizAns ? `<div class="w-full bg-emerald-50 p-6 rounded-2xl animate-in zoom-in"><p class="text-3xl font-black text-emerald-600 mb-4">${q.answer}</p><p class="text-slate-500 text-sm">${q.explanation || ''}</p></div>` : 
                    `<button onclick="showQuizAns=true;renderQuiz()" class="bg-slate-900 text-white px-10 py-4 rounded-full font-black shadow-xl hover:bg-indigo-600 transition-all">揭曉答案</button>`}
                </div>
                <div class="p-6 bg-slate-50 flex gap-4">
                    <button onclick="setView('list')" class="flex-1 font-bold text-slate-400">結束</button>
                    <button ${currentQuizIndex === quizList.length-1 ? 'disabled' : ''} onclick="currentQuizIndex++;showQuizAns=false;renderQuiz()" class="flex-[2] py-4 bg-indigo-600 text-white rounded-xl font-black disabled:opacity-30">下一題</button>
                </div>
            </div></div>`;
            lucide.createIcons();
        }

        function render() { currentView === 'list' ? renderList() : renderQuiz(); }

        function startQuiz() { if(questions.length===0) return alert('題庫為空'); quizList = [...questions].sort(()=>0.5-Math.random()).slice(0,10); currentQuizIndex=0; showQuizAns=false; setView('quiz'); }

        function toggleEditModal(s) { document.getElementById('edit-modal').style.display = s?'flex':'none'; if(!s) { editingId=null; ['f-question','f-answer','f-explanation','f-category'].forEach(id=>document.getElementById(id).value=''); } }
        function toggleImportModal(s) { document.getElementById('import-modal').style.display = s?'flex':'none'; }

        function saveQuestion() {
            const data = { id: editingId||Date.now(), question: document.getElementById('f-question').value, answer: document.getElementById('f-answer').value, explanation: document.getElementById('f-explanation').value, category: document.getElementById('f-category').value||'一般', difficulty: document.getElementById('f-difficulty').value, updatedAt: Date.now() };
            if(!data.question || !data.answer) return alert('必填！');
            if(editingId) questions = questions.map(q=>q.id===editingId?data:q);
            else questions.push({...data, createdAt: Date.now()});
            saveToLocal(); toggleEditModal(false); render();
        }

        function editQuestion(id) { const q = questions.find(q=>q.id===id); editingId=id; document.getElementById('f-question').value=q.question; document.getElementById('f-answer').value=q.answer; document.getElementById('f-explanation').value=q.explanation; document.getElementById('f-category').value=q.category; document.getElementById('f-difficulty').value=q.difficulty; toggleEditModal(true); }
        function deleteQuestion(id) { if(confirm('刪除？')) { questions=questions.filter(q=>q.id!==id); saveToLocal(); render(); } }

        function processBatchImport() {
            const text = document.getElementById('i-text').value;
            const cat = document.getElementById('i-category').value || '未分類';
            const chunks = text.split(/\n\s*\n|\n(?=\d+[\.、\s])/); // 根據題號或空行切分
            let count = 0;
            chunks.forEach(chunk => {
                const lines = chunk.split('\n').map(l=>l.trim()).filter(l=>l);
                if(lines.length > 1) {
                    let questionText = "";
                    let answerText = "";
                    let expText = "";
                    lines.forEach(line => {
                        if(line.match(/^(\d+[\.\、\s])/)) questionText = line.replace(/^\d+[\.\、\s]/, '').trim();
                        else if(line.match(/^(答|Ans|答案|解)[：:]/i)) answerText = line.replace(/.*[：:]/, '').trim();
                        else if(line.match(/^(解析|說明|Exp)[：:]/i)) expText = line.replace(/.*[：:]/, '').trim();
                        else if(!answerText) questionText += " " + line;
                    });
                    if(questionText && answerText) {
                        questions.push({ id: Date.now()+Math.random(), question: questionText, answer: answerText, explanation: expText, category: cat, difficulty: '中', createdAt: Date.now(), updatedAt: Date.now() });
                        count++;
                    }
                }
            });
            saveToLocal(); alert(`匯入 ${count} 題！`); toggleImportModal(false); render();
        }

        function exportData() { const b=new Blob([JSON.stringify(questions,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`題庫_${new Date().toLocaleDateString()}.json`; a.click(); }
        function importData(e) { const r=new FileReader(); r.onload=(e)=>{ const d=JSON.parse(e.target.result); if(confirm(`匯入 ${d.length} 題？`)) { questions=d; saveToLocal(); render(); } }; r.readAsText(e.target.files[0]); }
        window.onload = () => { lucide.createIcons(); render(); };
    </script>
</body>
</html>
